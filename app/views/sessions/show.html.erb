<h1>市場価値メーター</h1>

<% if user_signed_in? %>
  <span><%= current_user.email %></span>
  <%= link_to "ログアウト", destroy_user_session_path, data: { turbo_method: :delete } %>
<% else %>
  <%= link_to "ログイン", new_user_session_path %>
  <%= link_to "新規登録", new_user_registration_path %>
<% end %>

<h2>目標の入力</h2>


<%= form_with model: @session, url: update_target_session_path, method: :patch, local: true do |f| %>

    <label>目標金額(¥)</label>
    <%= f.number_field :target_price, step: 1 %>
    <% @session.errors.full_messages_for(:target_price).each do |msg| %>
        <%= msg %>
    <% end %>

    <label>目標時間(h)</label>
    <%= f.number_field :target_hours, step: 0.5 %>
    <% @session.errors.full_messages_for(:target_hours).each do |msg| %>
        <%= msg %>
    <% end %>

  <%= f.submit "変更" %>

<% end %>




<%# --- ここからサンプル（コメントアウト） ---
<div data-controller="tiny-timer">
  <span data-tiny-timer-target="elapsed">00:00:00</span>
  <button type="button" data-action="click->tiny-timer#start">Start</button>
  <button type="button" data-action="click->tiny-timer#stop">Stop</button>
</div>
--- ここまでコメントアウト --- %>

<div
  data-controller="tiny-timer"
  data-tiny-timer-initial-seconds-value="<%= @session.live_seconds %>"
  data-tiny-timer-running-value="<%= @session.running? %>">
  <span data-tiny-timer-target="elapsed">00:00:00</span>
</div>

<%= link_to "Start",
            start_session_path,
            data: {
              turbo_method: :post,
              action: "click->tiny-timer#handleStartClick",
              tiny_tiny_timer_target: nil, # ダミー防止（無視されます）
              tiny_timer_target: "startButton"
            },
            class: "btn start" %>

<%= link_to "Stop",
            stop_session_path,
            data: {
              turbo_method: :post,
              action: "click->tiny-timer#handleStopClick",
              tiny_timer_target: "stopButton"
            },
            class: "btn stop" %>

<%= link_to "タイマーReset",
            reset_session_path,
            data: {
                turbo_method: :post,
                turbo_confirm: "本当にリセットしますか？（合計時間が0に戻ります）",
                action: "click->tiny-timer#stop"
            },
            class: "btn reset" %>
            <% if notice.present? %>
    <p class="notice"><%= notice %></p>
    <% end %>

<h2>詳細</h2>
<p>１時間で稼げる額: ¥<%= @session.hour_price.round %></p>
<p>現在の市場価値: ¥<%= @session.now_price.round %></p>




<!-- app/views/sessions/show.html.erb の見やすい位置に追記 -->
<section class="today-summary">
  <h2>今日の達成（24時リセット）</h2>
  <p>1日の合計時間：<strong><%= format_duration(@session.today_total_seconds) %></strong></p>
  <p>1日で稼いだ価値： 
    <strong>
      <%= number_to_currency(@session.hour_price * (@session.today_total_seconds / 3600.0), unit: "¥", precision: 0) %>
    </strong>
  </p>
</section>
